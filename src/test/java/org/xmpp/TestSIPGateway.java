package org.xmpp;

import junit.framework.TestCase;
import org.apache.log4j.BasicConfigurator;
import org.apache.log4j.Logger;
import org.jinglenodes.Main;
import org.jinglenodes.jingle.Jingle;
import org.jinglenodes.jingle.Reason;
import org.jinglenodes.jingle.content.Content;
import org.jinglenodes.jingle.description.Description;
import org.jinglenodes.jingle.description.Payload;
import org.jinglenodes.jingle.processor.JingleProcessor;
import org.jinglenodes.jingle.transport.Candidate;
import org.jinglenodes.jingle.transport.RawUdpTransport;
import org.jinglenodes.session.CallSession;
import org.jinglenodes.session.persistence.PersistentCallSessionMapper;
import org.jinglenodes.sip.account.CachedSipAccountProvider;
import org.jinglenodes.sip.processor.SipProcessor;
import org.jinglenodes.sip.router.SipRoutingError;
import org.jinglenodes.sip.router.SipRoutingListener;
import org.xmpp.packet.JID;
import org.xmpp.tinder.JingleIQ;
import org.zoolu.sip.message.Message;

import java.io.IOException;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * Created by IntelliJ IDEA.
 * User: thiago
 * Date: 3/20/12
 * Time: 3:32 PM
 */
public class TestSIPGateway extends TestCase {

    private static final Logger log = Logger.getLogger(TestSIPGateway.class);
    private final AtomicInteger sipInviteSent = new AtomicInteger(0);
    private final AtomicInteger sipAcceptSent = new AtomicInteger(0);
    private final AtomicInteger sipByeSent = new AtomicInteger(0);
    private final AtomicInteger sipCancelSent = new AtomicInteger(0);
    static SipServerMock sipServerMock;

    static {
        BasicConfigurator.configure();
        Main.setAppDir(System.getProperty("user.dir") + "/target/test-classes/");
        Main.start("sipgatewaytest.xml");
        try {
            sipServerMock = new SipServerMock();
        } catch (IOException e) {
            e.printStackTrace();
        }
    }

    public TestSIPGateway() throws IOException {

    }

    public void testSessionPersistence() throws Exception {

        resetCounters();

        final JingleProcessor jingleProcessor = Main.getSipGatewayApplication().getJingleProcessor();
        final SipRoutingListener sipRoutingListener = new SipRoutingListener() {
            @Override
            public void routingSIP(Message message, JID sender) {
            }

            @Override
            public void routedSIP(Message message, JID sender) {
                System.out.println("Sent SIP Packet: " + message.toString());
                if (message.isInvite())
                    sipInviteSent.incrementAndGet();
                if (message.isBye())
                    sipByeSent.incrementAndGet();
                if (message.isCancel())
                    sipCancelSent.incrementAndGet();
            }

            @Override
            public void routingError(Message message, JID sender, SipRoutingError error) {
            }
        };
        Main.getSipGatewayApplication().getSipGatewayComponent().getGatewaySipRouter().addRoutingListener(sipRoutingListener);

        PersistentCallSessionMapper sessionMapper = (PersistentCallSessionMapper) jingleProcessor.getCallSessionMapper();
        sessionMapper.clear();
        sessionMapper.reset();

        final String sid = String.valueOf(Math.random() * 5000 + 1000);

        final JingleIQ init = fakeJingleInitiate("initiator@abc.com", "responder@abc.com", "sip.abc.com", sid);

        jingleProcessor.processIQ(init);
        Thread.sleep(100);
        sessionMapper.clear();
        final CachedSipAccountProvider sipAccountProvider = (CachedSipAccountProvider) Main.getSipGatewayApplication().getSipGatewayComponent().getGatewaySipRouter().getSipAccountProvider();
        sipAccountProvider.clearCachedAccounts();

        sessionMapper.load();

        assertEquals(1, sessionMapper.getSessionCount());

        final Jingle jt = new Jingle(init.getJingle().getSid(), init.getJingle().getInitiator(), init.getJingle().getResponder(), Jingle.SESSION_TERMINATE);
        jt.setReason(new Reason(Reason.Type.success));
        jingleProcessor.processIQ(new JingleIQ(jt));

        for (int i = 0; i < 5; i++)
            Thread.sleep(200);

        final CallSession cs = jingleProcessor.getCallSessionMapper().getSession(new JingleIQ(jt));

        assertNotNull(cs.getProceeds());

        String x = "";
        byte[] ba = null;
        long st = System.currentTimeMillis();
        for (int i = 0; i < 100; i++) {
            try {
                x = sessionMapper.toXml(cs);
                ba = sessionMapper.zip(x);
                x = sessionMapper.unzip(ba);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
        System.out.println("Elapsed " + (System.currentTimeMillis() - st) + " for 100 marshal. Compressed to: " + ba.length);

        st = System.currentTimeMillis();
        for (int i = 0; i < 100; i++) {
            try {
                final CallSession cs2 = sessionMapper.fromXml(x);
            } catch (Exception e) {
                e.printStackTrace();
            }
        }
        System.out.println("Elapsed " + (System.currentTimeMillis() - st) + " for 100 unmarshal");

        final String t1 = "<org.jinglenodes.session.CallSession>\n  <id>9C6BAB149CCC48799925E9E5F2B2B18B</id>\n  <user class=\"java.util.concurrent.CopyOnWriteArrayList\" serialization=\"custom\">\n    <java.util.concurrent.CopyOnWriteArrayList>\n      <default/>\n      <int>1</int>\n      <org.xmpp.packet.JID>\n        <node>+34634538708</node>\n        <domain>yuilop.tv</domain>\n        <resource>I(1.4.0.201205152)(tg07qk5r/0Aqt8mc/YMFu4L4wto=)</resource>\n      </org.xmpp.packet.JID>\n    </java.util.concurrent.CopyOnWriteArrayList>\n  </user>\n  <lastSentRequest>\n    <remotePort>0</remotePort>\n    <message></message>\n    <SIP__RESPONSEPRE>SIP/</SIP__RESPONSEPRE>\n    <request__line>\n      <method>INVITE</method>\n      <url>\n        <url>sip:0031611537782@sip.yuilop.tv</url>\n      </url>\n    </request__line>\n    <headers>\n      <org.zoolu.sip.header.ViaHeader>\n        <name>Via</name>\n        <value>SIP/2.0/UDP 194.183.72.28:5060;rport;branch=z9hG4bK9C6BAB149CCC48799925E9E5F2B2B18B</value>\n      </org.zoolu.sip.header.ViaHeader>\n      <org.zoolu.sip.header.MaxForwardsHeader>\n        <name>Max-Forwards</name>\n        <value>70</value>\n      </org.zoolu.sip.header.MaxForwardsHeader>\n      <org.zoolu.sip.header.ToHeader>\n        <name>To</name>\n        <value>&quot;0031611537782&quot; &lt;sip:0031611537782@sip.yuilop.tv&gt;</value>\n      </org.zoolu.sip.header.ToHeader>\n      <org.zoolu.sip.header.FromHeader>\n        <name>From</name>\n        <value>&quot;+34634538708@194.183.72.28&quot; &lt;sip:+34634538708@194.183.72.28&gt;;tag=sip</value>\n      </org.zoolu.sip.header.FromHeader>\n      <org.zoolu.sip.header.CallIdHeader>\n        <name>Call-ID</name>\n        <value>9C6BAB149CCC48799925E9E5F2B2B18B</value>\n      </org.zoolu.sip.header.CallIdHeader>\n      <org.zoolu.sip.header.CSeqHeader>\n        <name>CSeq</name>\n        <value>1 INVITE</value>\n      </org.zoolu.sip.header.CSeqHeader>\n      <org.zoolu.sip.header.Header>\n        <name>Contact</name>\n        <value>&lt;sip:+34634538708@194.183.72.28:5060;transport=udp&gt;</value>\n      </org.zoolu.sip.header.Header>\n      <org.zoolu.sip.header.ExpiresHeader>\n        <name>Expires</name>\n        <value>3600</value>\n      </org.zoolu.sip.header.ExpiresHeader>\n      <org.zoolu.sip.header.UserAgentHeader>\n        <name>User-Agent</name>\n        <value>Jingle Nodes Single</value>\n      </org.zoolu.sip.header.UserAgentHeader>\n      <org.zoolu.sip.header.ContentTypeHeader>\n        <name>Content-Type</name>\n        <value>application/sdp</value>\n      </org.zoolu.sip.header.ContentTypeHeader>\n      <org.zoolu.sip.header.ContentLengthHeader>\n        <name>Content-Length</name>\n        <value>240</value>\n      </org.zoolu.sip.header.ContentLengthHeader>\n    </headers>\n    <body>v=0&#xd;\no=J2S 3 1 IN IP4 87.230.83.87&#xd;\ns=-&#xd;\nc=IN IP4 87.230.83.87&#xd;\nt=0 0&#xd;\nm=audio 6092 RTP/AVP 0 8 104 18 3&#xd;\na=rtpmap:0 PCMU/8000/1&#xd;\na=rtpmap:8 PCMA/8000/1&#xd;\na=rtpmap:104 iLBC/8000/1&#xd;\na=rtpmap:18 G729/8000/1&#xd;\na=rtpmap:3 GSM/8000/1&#xd;\na=sendrecv&#xd;\n</body>\n  </lastSentRequest>\n  <lastReceivedResponse>\n    <remotePort>0</remotePort>\n    <message></message>\n    <SIP__RESPONSEPRE>SIP/</SIP__RESPONSEPRE>\n    <status__line>\n      <code>183</code>\n      <reason>Session Progress</reason>\n    </status__line>\n    <headers>\n      <org.zoolu.sip.header.Header>\n        <name>Via</name>\n        <value>SIP/2.0/UDP 194.183.72.28:5060;branch=z9hG4bK9C6BAB149CCC48799925E9E5F2B2B18B;received=178.33.112.237;rport=5062</value>\n      </org.zoolu.sip.header.Header>\n      <org.zoolu.sip.header.Header>\n        <name>From</name>\n        <value>&quot;+34634538708@194.183.72.28&quot; &lt;sip:+34634538708@194.183.72.28&gt;;tag=sip</value>\n      </org.zoolu.sip.header.Header>\n      <org.zoolu.sip.header.Header>\n        <name>To</name>\n        <value>&quot;0031611537782&quot; &lt;sip:0031611537782@sip.yuilop.tv&gt;;tag=as1aec4047</value>\n      </org.zoolu.sip.header.Header>\n      <org.zoolu.sip.header.Header>\n        <name>Call-ID</name>\n        <value>9C6BAB149CCC48799925E9E5F2B2B18B</value>\n      </org.zoolu.sip.header.Header>\n      <org.zoolu.sip.header.Header>\n        <name>CSeq</name>\n        <value>1 INVITE</value>\n      </org.zoolu.sip.header.Header>\n      <org.zoolu.sip.header.Header>\n        <name>User-Agent</name>\n        <value>Asterisk PBX 1.6.0.26-FONCORE-r78</value>\n      </org.zoolu.sip.header.Header>\n      <org.zoolu.sip.header.Header>\n        <name>Allow</name>\n        <value>INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, SUBSCRIBE, NOTIFY, INFO</value>\n      </org.zoolu.sip.header.Header>\n      <org.zoolu.sip.header.Header>\n        <name>Supported</name>\n        <value>replaces, timer</value>\n      </org.zoolu.sip.header.Header>\n      <org.zoolu.sip.header.Header>\n        <name>Contact</name>\n        <value>&lt;sip:0031611537782@194.183.72.28&gt;</value>\n      </org.zoolu.sip.header.Header>\n      <org.zoolu.sip.header.Header>\n        <name>Content-Type</name>\n        <value>application/sdp</value>\n      </org.zoolu.sip.header.Header>\n      <org.zoolu.sip.header.Header>\n        <name>Content-Length</name>\n        <value>314</value>\n      </org.zoolu.sip.header.Header>\n    </headers>\n    <body>v=0&#xd;\no=root 855364504 855364504 IN IP4 194.183.72.28&#xd;\ns=Asterisk PBX 1.6.0.26-FONCORE-r78&#xd;\nc=IN IP4 194.183.72.28&#xd;\nt=0 0&#xd;\nm=audio 17848 RTP/AVP 18 3 8 0&#xd;\na=rtpmap:18 G729/8000&#xd;\na=fmtp:18 annexb=no&#xd;\na=rtpmap:3 GSM/8000&#xd;\na=rtpmap:8 PCMA/8000&#xd;\na=rtpmap:0 PCMU/8000&#xd;\na=silenceSupp:off - - - -&#xd;\na=ptime:20&#xd;\na=sendrecv&#xd;\n&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;&#x0;</body>\n  </lastReceivedResponse>\n  <lastMessage reference=\"../lastReceivedResponse\"/>\n  <sentJingle>\n    <element class=\"org.dom4j.tree.DefaultElement\">\n      <qname serialization=\"custom\">\n        <org.dom4j.QName>\n          <string></string>\n          <string></string>\n          <default>\n            <hashCode>0</hashCode>\n            <documentFactory serialization=\"custom\">\n              <org.dom4j.DocumentFactory>\n                <default/>\n              </org.dom4j.DocumentFactory>\n            </documentFactory>\n            <name>iq</name>\n            <qualifiedName>iq</qualifiedName>\n          </default>\n        </org.dom4j.QName>\n      </qname>\n      <parentBranch class=\"org.dom4j.tree.DefaultDocument\">\n        <rootElement class=\"org.dom4j.tree.DefaultElement\" reference=\"../..\"/>\n        <content>\n          <org.dom4j.tree.DefaultElement reference=\"../../..\"/>\n        </content>\n        <documentFactory reference=\"../../qname/org.dom4j.QName/default/documentFactory\"/>\n      </parentBranch>\n      <content class=\"org.dom4j.tree.DefaultElement\">\n        <qname serialization=\"custom\">\n          <org.dom4j.QName>\n            <string></string>\n            <string>urn:xmpp:jingle:1</string>\n            <default>\n              <hashCode>0</hashCode>\n              <documentFactory reference=\"../../../../../qname/org.dom4j.QName/default/documentFactory\"/>\n              <name>jingle</name>\n              <qualifiedName>jingle</qualifiedName>\n            </default>\n          </org.dom4j.QName>\n        </qname>\n        <parentBranch class=\"org.dom4j.tree.DefaultElement\" reference=\"../..\"/>\n        <content class=\"list\">\n          <org.dom4j.Namespace>\n            <prefix></prefix>\n            <uri>urn:xmpp:jingle:1</uri>\n            <hashCode>1075572100</hashCode>\n          </org.dom4j.Namespace>\n          <org.dom4j.tree.DefaultText>\n            <text>\n  </text>\n            <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n          </org.dom4j.tree.DefaultText>\n          <org.dom4j.tree.DefaultElement>\n            <qname serialization=\"custom\">\n              <org.dom4j.QName>\n                <string></string>\n                <string>urn:xmpp:jingle:apps:rtp:info:1</string>\n                <default>\n                  <hashCode>0</hashCode>\n                  <documentFactory reference=\"../../../../../../../qname/org.dom4j.QName/default/documentFactory\"/>\n                  <name>ringing</name>\n                  <qualifiedName>ringing</qualifiedName>\n                </default>\n              </org.dom4j.QName>\n            </qname>\n            <parentBranch class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n            <content class=\"org.dom4j.Namespace\">\n              <prefix></prefix>\n              <uri>urn:xmpp:jingle:apps:rtp:info:1</uri>\n              <hashCode>1061645580</hashCode>\n            </content>\n          </org.dom4j.tree.DefaultElement>\n          <org.dom4j.tree.DefaultText>\n            <text>\n</text>\n            <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n          </org.dom4j.tree.DefaultText>\n        </content>\n        <attributes class=\"list\">\n          <org.dom4j.tree.DefaultAttribute>\n            <qname serialization=\"custom\">\n              <org.dom4j.QName>\n                <string></string>\n                <string></string>\n                <default>\n                  <hashCode>-1422950858</hashCode>\n                  <documentFactory reference=\"../../../../../../../qname/org.dom4j.QName/default/documentFactory\"/>\n                  <name>action</name>\n                  <qualifiedName>action</qualifiedName>\n                </default>\n              </org.dom4j.QName>\n            </qname>\n            <value>session-info</value>\n            <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n          </org.dom4j.tree.DefaultAttribute>\n          <org.dom4j.tree.DefaultAttribute>\n            <qname serialization=\"custom\">\n              <org.dom4j.QName>\n                <string></string>\n                <string></string>\n                <default>\n                  <hashCode>113870</hashCode>\n                  <documentFactory reference=\"../../../../../../../qname/org.dom4j.QName/default/documentFactory\"/>\n                  <name>sid</name>\n                  <qualifiedName>sid</qualifiedName>\n                </default>\n              </org.dom4j.QName>\n            </qname>\n            <value>9C6BAB149CCC48799925E9E5F2B2B18B</value>\n            <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n          </org.dom4j.tree.DefaultAttribute>\n          <org.dom4j.tree.DefaultAttribute>\n            <qname serialization=\"custom\">\n              <org.dom4j.QName>\n                <string></string>\n                <string></string>\n                <default>\n                  <hashCode>-248987089</hashCode>\n                  <documentFactory reference=\"../../../../../../../qname/org.dom4j.QName/default/documentFactory\"/>\n                  <name>initiator</name>\n                  <qualifiedName>initiator</qualifiedName>\n                </default>\n              </org.dom4j.QName>\n            </qname>\n            <value>+34634538708@194.183.72.28/sip</value>\n            <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n          </org.dom4j.tree.DefaultAttribute>\n          <org.dom4j.tree.DefaultAttribute>\n            <qname serialization=\"custom\">\n              <org.dom4j.QName>\n                <string></string>\n                <string></string>\n                <default>\n                  <hashCode>-1960100862</hashCode>\n                  <documentFactory reference=\"../../../../../../../qname/org.dom4j.QName/default/documentFactory\"/>\n                  <name>responder</name>\n                  <qualifiedName>responder</qualifiedName>\n                </default>\n              </org.dom4j.QName>\n            </qname>\n            <value>0031611537782@sip.yuilop.tv/as1aec4047</value>\n            <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n          </org.dom4j.tree.DefaultAttribute>\n        </attributes>\n      </content>\n      <attributes class=\"list\">\n        <org.dom4j.tree.DefaultAttribute>\n          <qname serialization=\"custom\">\n            <org.dom4j.QName>\n              <string></string>\n              <string></string>\n              <default>\n                <hashCode>3575610</hashCode>\n                <documentFactory reference=\"../../../../../../qname/org.dom4j.QName/default/documentFactory\"/>\n                <name>type</name>\n                <qualifiedName>type</qualifiedName>\n              </default>\n            </org.dom4j.QName>\n          </qname>\n          <value>set</value>\n          <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n        </org.dom4j.tree.DefaultAttribute>\n        <org.dom4j.tree.DefaultAttribute>\n          <qname serialization=\"custom\">\n            <org.dom4j.QName>\n              <string></string>\n              <string></string>\n              <default>\n                <hashCode>3355</hashCode>\n                <documentFactory reference=\"../../../../../../qname/org.dom4j.QName/default/documentFactory\"/>\n                <name>id</name>\n                <qualifiedName>id</qualifiedName>\n              </default>\n            </org.dom4j.QName>\n          </qname>\n          <value>470-7</value>\n          <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n        </org.dom4j.tree.DefaultAttribute>\n        <org.dom4j.tree.DefaultAttribute>\n          <qname serialization=\"custom\">\n            <org.dom4j.QName>\n              <string></string>\n              <string></string>\n              <default>\n                <hashCode>3707</hashCode>\n                <documentFactory reference=\"../../../../../../qname/org.dom4j.QName/default/documentFactory\"/>\n                <name>to</name>\n                <qualifiedName>to</qualifiedName>\n              </default>\n            </org.dom4j.QName>\n          </qname>\n          <value>+34634538708@yuilop.tv/I(1.4.0.201205152)(tg07qk5r/0Aqt8mc/YMFu4L4wto=)</value>\n          <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n        </org.dom4j.tree.DefaultAttribute>\n        <org.dom4j.tree.DefaultAttribute>\n          <qname serialization=\"custom\">\n            <org.dom4j.QName>\n              <string></string>\n              <string></string>\n              <default>\n                <hashCode>3151786</hashCode>\n                <documentFactory reference=\"../../../../../../qname/org.dom4j.QName/default/documentFactory\"/>\n                <name>from</name>\n                <qualifiedName>from</qualifiedName>\n              </default>\n            </org.dom4j.QName>\n          </qname>\n          <value>0031611537782@sip.yuilop.tv/as1aec4047</value>\n          <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n        </org.dom4j.tree.DefaultAttribute>\n      </attributes>\n    </element>\n    <toJID>\n      <node>+34634538708</node>\n      <domain>yuilop.tv</domain>\n      <resource>I(1.4.0.201205152)(tg07qk5r/0Aqt8mc/YMFu4L4wto=)</resource>\n    </toJID>\n    <fromJID>\n      <node>0031611537782</node>\n      <domain>sip.yuilop.tv</domain>\n      <resource>as1aec4047</resource>\n    </fromJID>\n    <jingle xmlns=\"urn:xmpp:jingle:1\" action=\"session-info\" sid=\"9C6BAB149CCC48799925E9E5F2B2B18B\" initiator=\"+34634538708@194.183.72.28/sip\" responder=\"0031611537782@sip.yuilop.tv/as1aec4047\">\n      <ringing xmlns=\"urn:xmpp:jingle:apps:rtp:info:1\"/>\n    </jingle>\n  </sentJingle>\n  <receivedJingle>\n    <element class=\"org.dom4j.tree.DefaultElement\">\n      <qname reference=\"../../../sentJingle/element/qname\"/>\n      <parentBranch class=\"org.dom4j.tree.DefaultDocument\">\n        <rootElement class=\"org.dom4j.tree.DefaultElement\" reference=\"../..\"/>\n        <content>\n          <org.dom4j.tree.DefaultElement reference=\"../../..\"/>\n        </content>\n        <documentFactory reference=\"../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n      </parentBranch>\n      <content class=\"org.dom4j.tree.DefaultElement\">\n        <qname reference=\"../../../../sentJingle/element/content/qname\"/>\n        <parentBranch class=\"org.dom4j.tree.DefaultElement\" reference=\"../..\"/>\n        <content class=\"list\">\n          <org.dom4j.Namespace reference=\"../../../../../sentJingle/element/content/content/org.dom4j.Namespace\"/>\n          <org.dom4j.tree.DefaultText>\n            <text>\n  </text>\n            <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n          </org.dom4j.tree.DefaultText>\n          <org.dom4j.tree.DefaultElement>\n            <qname serialization=\"custom\">\n              <org.dom4j.QName>\n                <string></string>\n                <string>urn:xmpp:jingle:1</string>\n                <default>\n                  <hashCode>0</hashCode>\n                  <documentFactory reference=\"../../../../../../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n                  <name>content</name>\n                  <qualifiedName>content</qualifiedName>\n                </default>\n              </org.dom4j.QName>\n            </qname>\n            <parentBranch class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n            <content class=\"list\">\n              <org.dom4j.tree.DefaultText>\n                <text>\n    </text>\n                <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n              </org.dom4j.tree.DefaultText>\n              <org.dom4j.tree.DefaultElement>\n                <qname serialization=\"custom\">\n                  <org.dom4j.QName>\n                    <string></string>\n                    <string>urn:xmpp:jingle:apps:rtp:1</string>\n                    <default>\n                      <hashCode>0</hashCode>\n                      <documentFactory reference=\"../../../../../../../../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n                      <name>description</name>\n                      <qualifiedName>description</qualifiedName>\n                    </default>\n                  </org.dom4j.QName>\n                </qname>\n                <parentBranch class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                <content class=\"list\">\n                  <org.dom4j.Namespace>\n                    <prefix></prefix>\n                    <uri>urn:xmpp:jingle:apps:rtp:1</uri>\n                    <hashCode>-319226070</hashCode>\n                  </org.dom4j.Namespace>\n                  <org.dom4j.tree.DefaultText>\n                    <text>\n      </text>\n                    <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                  </org.dom4j.tree.DefaultText>\n                  <org.dom4j.tree.DefaultElement>\n                    <qname serialization=\"custom\">\n                      <org.dom4j.QName>\n                        <string></string>\n                        <string>urn:xmpp:jingle:apps:rtp:1</string>\n                        <default>\n                          <hashCode>0</hashCode>\n                          <documentFactory reference=\"../../../../../../../../../../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n                          <name>payload-type</name>\n                          <qualifiedName>payload-type</qualifiedName>\n                        </default>\n                      </org.dom4j.QName>\n                    </qname>\n                    <parentBranch class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                    <attributes class=\"list\">\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../../../../../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute[2]/qname\"/>\n                        <value>0</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname serialization=\"custom\">\n                          <org.dom4j.QName>\n                            <string></string>\n                            <string></string>\n                            <default>\n                              <hashCode>3373707</hashCode>\n                              <documentFactory reference=\"../../../../../../../../../../../../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n                              <name>name</name>\n                              <qualifiedName>name</qualifiedName>\n                            </default>\n                          </org.dom4j.QName>\n                        </qname>\n                        <value>PCMU</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname serialization=\"custom\">\n                          <org.dom4j.QName>\n                            <string></string>\n                            <string></string>\n                            <default>\n                              <hashCode>-934120978</hashCode>\n                              <documentFactory reference=\"../../../../../../../../../../../../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n                              <name>clockrate</name>\n                              <qualifiedName>clockrate</qualifiedName>\n                            </default>\n                          </org.dom4j.QName>\n                        </qname>\n                        <value>8000</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname serialization=\"custom\">\n                          <org.dom4j.QName>\n                            <string></string>\n                            <string></string>\n                            <default>\n                              <hashCode>1432626128</hashCode>\n                              <documentFactory reference=\"../../../../../../../../../../../../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n                              <name>channels</name>\n                              <qualifiedName>channels</qualifiedName>\n                            </default>\n                          </org.dom4j.QName>\n                        </qname>\n                        <value>1</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                    </attributes>\n                  </org.dom4j.tree.DefaultElement>\n                  <org.dom4j.tree.DefaultText>\n                    <text>\n      </text>\n                    <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                  </org.dom4j.tree.DefaultText>\n                  <org.dom4j.tree.DefaultElement>\n                    <qname reference=\"../../org.dom4j.tree.DefaultElement/qname\"/>\n                    <parentBranch class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                    <attributes class=\"list\">\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../../../../../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute[2]/qname\"/>\n                        <value>8</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../org.dom4j.tree.DefaultElement/attributes/org.dom4j.tree.DefaultAttribute[2]/qname\"/>\n                        <value>PCMA</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../org.dom4j.tree.DefaultElement/attributes/org.dom4j.tree.DefaultAttribute[3]/qname\"/>\n                        <value>8000</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../org.dom4j.tree.DefaultElement/attributes/org.dom4j.tree.DefaultAttribute[4]/qname\"/>\n                        <value>1</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                    </attributes>\n                  </org.dom4j.tree.DefaultElement>\n                  <org.dom4j.tree.DefaultText>\n                    <text>\n      </text>\n                    <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                  </org.dom4j.tree.DefaultText>\n                  <org.dom4j.tree.DefaultElement>\n                    <qname reference=\"../../org.dom4j.tree.DefaultElement/qname\"/>\n                    <parentBranch class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                    <attributes class=\"list\">\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../../../../../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute[2]/qname\"/>\n                        <value>104</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../org.dom4j.tree.DefaultElement/attributes/org.dom4j.tree.DefaultAttribute[2]/qname\"/>\n                        <value>iLBC</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../org.dom4j.tree.DefaultElement/attributes/org.dom4j.tree.DefaultAttribute[3]/qname\"/>\n                        <value>8000</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../org.dom4j.tree.DefaultElement/attributes/org.dom4j.tree.DefaultAttribute[4]/qname\"/>\n                        <value>1</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                    </attributes>\n                  </org.dom4j.tree.DefaultElement>\n                  <org.dom4j.tree.DefaultText>\n                    <text>\n      </text>\n                    <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                  </org.dom4j.tree.DefaultText>\n                  <org.dom4j.tree.DefaultElement>\n                    <qname reference=\"../../org.dom4j.tree.DefaultElement/qname\"/>\n                    <parentBranch class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                    <attributes class=\"list\">\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../../../../../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute[2]/qname\"/>\n                        <value>18</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../org.dom4j.tree.DefaultElement/attributes/org.dom4j.tree.DefaultAttribute[2]/qname\"/>\n                        <value>G729</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../org.dom4j.tree.DefaultElement/attributes/org.dom4j.tree.DefaultAttribute[3]/qname\"/>\n                        <value>8000</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../org.dom4j.tree.DefaultElement/attributes/org.dom4j.tree.DefaultAttribute[4]/qname\"/>\n                        <value>1</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                    </attributes>\n                  </org.dom4j.tree.DefaultElement>\n                  <org.dom4j.tree.DefaultText>\n                    <text>\n      </text>\n                    <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                  </org.dom4j.tree.DefaultText>\n                  <org.dom4j.tree.DefaultElement>\n                    <qname reference=\"../../org.dom4j.tree.DefaultElement/qname\"/>\n                    <parentBranch class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                    <attributes class=\"list\">\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../../../../../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute[2]/qname\"/>\n                        <value>3</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../org.dom4j.tree.DefaultElement/attributes/org.dom4j.tree.DefaultAttribute[2]/qname\"/>\n                        <value>GSM</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../org.dom4j.tree.DefaultElement/attributes/org.dom4j.tree.DefaultAttribute[3]/qname\"/>\n                        <value>8000</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../org.dom4j.tree.DefaultElement/attributes/org.dom4j.tree.DefaultAttribute[4]/qname\"/>\n                        <value>1</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                    </attributes>\n                  </org.dom4j.tree.DefaultElement>\n                  <org.dom4j.tree.DefaultText>\n                    <text>\n    </text>\n                    <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                  </org.dom4j.tree.DefaultText>\n                </content>\n                <attributes class=\"org.dom4j.tree.DefaultAttribute\">\n                  <qname serialization=\"custom\">\n                    <org.dom4j.QName>\n                      <string></string>\n                      <string></string>\n                      <default>\n                        <hashCode>0</hashCode>\n                        <documentFactory reference=\"../../../../../../../../../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n                        <name>media</name>\n                        <qualifiedName>media</qualifiedName>\n                      </default>\n                    </org.dom4j.QName>\n                  </qname>\n                  <value>audio</value>\n                  <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../..\"/>\n                </attributes>\n              </org.dom4j.tree.DefaultElement>\n              <org.dom4j.tree.DefaultText>\n                <text>\n    </text>\n                <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n              </org.dom4j.tree.DefaultText>\n              <org.dom4j.tree.DefaultElement>\n                <qname serialization=\"custom\">\n                  <org.dom4j.QName>\n                    <string></string>\n                    <string>urn:xmpp:jingle:1</string>\n                    <default>\n                      <hashCode>0</hashCode>\n                      <documentFactory reference=\"../../../../../../../../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n                      <name>transport</name>\n                      <qualifiedName>transport</qualifiedName>\n                    </default>\n                  </org.dom4j.QName>\n                </qname>\n                <parentBranch class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                <content class=\"list\">\n                  <org.dom4j.tree.DefaultText>\n                    <text>\n      </text>\n                    <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                  </org.dom4j.tree.DefaultText>\n                  <org.dom4j.tree.DefaultElement>\n                    <qname serialization=\"custom\">\n                      <org.dom4j.QName>\n                        <string></string>\n                        <string>urn:xmpp:jingle:1</string>\n                        <default>\n                          <hashCode>0</hashCode>\n                          <documentFactory reference=\"../../../../../../../../../../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n                          <name>candidate</name>\n                          <qualifiedName>candidate</qualifiedName>\n                        </default>\n                      </org.dom4j.QName>\n                    </qname>\n                    <parentBranch class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                    <attributes class=\"list\">\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname serialization=\"custom\">\n                          <org.dom4j.QName>\n                            <string></string>\n                            <string></string>\n                            <default>\n                              <hashCode>3367</hashCode>\n                              <documentFactory reference=\"../../../../../../../../../../../../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n                              <name>ip</name>\n                              <qualifiedName>ip</qualifiedName>\n                            </default>\n                          </org.dom4j.QName>\n                        </qname>\n                        <value>192.168.2.17</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname serialization=\"custom\">\n                          <org.dom4j.QName>\n                            <string></string>\n                            <string></string>\n                            <default>\n                              <hashCode>3446913</hashCode>\n                              <documentFactory reference=\"../../../../../../../../../../../../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n                              <name>port</name>\n                              <qualifiedName>port</qualifiedName>\n                            </default>\n                          </org.dom4j.QName>\n                        </qname>\n                        <value>4000</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                      <org.dom4j.tree.DefaultAttribute>\n                        <qname reference=\"../../../../../../../../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute/qname\"/>\n                        <value>host</value>\n                        <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                      </org.dom4j.tree.DefaultAttribute>\n                    </attributes>\n                  </org.dom4j.tree.DefaultElement>\n                  <org.dom4j.tree.DefaultText>\n                    <text>\n    </text>\n                    <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n                  </org.dom4j.tree.DefaultText>\n                </content>\n              </org.dom4j.tree.DefaultElement>\n              <org.dom4j.tree.DefaultText>\n                <text>\n  </text>\n                <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n              </org.dom4j.tree.DefaultText>\n            </content>\n            <attributes class=\"list\">\n              <org.dom4j.tree.DefaultAttribute>\n                <qname serialization=\"custom\">\n                  <org.dom4j.QName>\n                    <string></string>\n                    <string></string>\n                    <default>\n                      <hashCode>1028554796</hashCode>\n                      <documentFactory reference=\"../../../../../../../../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n                      <name>creator</name>\n                      <qualifiedName>creator</qualifiedName>\n                    </default>\n                  </org.dom4j.QName>\n                </qname>\n                <value>initiator</value>\n                <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n              </org.dom4j.tree.DefaultAttribute>\n              <org.dom4j.tree.DefaultAttribute>\n                <qname reference=\"../../../content/org.dom4j.tree.DefaultElement/content/org.dom4j.tree.DefaultElement/attributes/org.dom4j.tree.DefaultAttribute[2]/qname\"/>\n                <value>voice</value>\n                <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n              </org.dom4j.tree.DefaultAttribute>\n            </attributes>\n          </org.dom4j.tree.DefaultElement>\n          <org.dom4j.tree.DefaultText>\n            <text>\n</text>\n            <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n          </org.dom4j.tree.DefaultText>\n        </content>\n        <attributes class=\"list\">\n          <org.dom4j.tree.DefaultAttribute>\n            <qname reference=\"../../../../../../sentJingle/element/content/attributes/org.dom4j.tree.DefaultAttribute/qname\"/>\n            <value>session-initiate</value>\n            <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n          </org.dom4j.tree.DefaultAttribute>\n          <org.dom4j.tree.DefaultAttribute>\n            <qname reference=\"../../../../../../sentJingle/element/content/attributes/org.dom4j.tree.DefaultAttribute[2]/qname\"/>\n            <value>9C6BAB149CCC48799925E9E5F2B2B18B</value>\n            <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n          </org.dom4j.tree.DefaultAttribute>\n          <org.dom4j.tree.DefaultAttribute>\n            <qname reference=\"../../../../../../sentJingle/element/content/attributes/org.dom4j.tree.DefaultAttribute[3]/qname\"/>\n            <value>+34634538708@yuilop.tv/I(1.4.0.201205152)(tg07qk5r/0Aqt8mc/YMFu4L4wto=)</value>\n            <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n          </org.dom4j.tree.DefaultAttribute>\n          <org.dom4j.tree.DefaultAttribute>\n            <qname reference=\"../../../../../../sentJingle/element/content/attributes/org.dom4j.tree.DefaultAttribute[4]/qname\"/>\n            <value>0031611537782@sip.yuilop.tv</value>\n            <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n          </org.dom4j.tree.DefaultAttribute>\n        </attributes>\n      </content>\n      <attributes class=\"list\">\n        <org.dom4j.tree.DefaultAttribute>\n          <qname reference=\"../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute/qname\"/>\n          <value>set</value>\n          <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n        </org.dom4j.tree.DefaultAttribute>\n        <org.dom4j.tree.DefaultAttribute>\n          <qname reference=\"../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute[2]/qname\"/>\n          <value>FBB522B1-07ED-45E0-ABCE-63A3615A1621</value>\n          <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n        </org.dom4j.tree.DefaultAttribute>\n        <org.dom4j.tree.DefaultAttribute>\n          <qname reference=\"../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute[3]/qname\"/>\n          <value>sip.yuilop.tv</value>\n          <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n        </org.dom4j.tree.DefaultAttribute>\n        <org.dom4j.tree.DefaultAttribute>\n          <qname reference=\"../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute[4]/qname\"/>\n          <value>+34634538708@yuilop.tv/I(1.4.0.201205152)(tg07qk5r/0Aqt8mc/YMFu4L4wto=)</value>\n          <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n        </org.dom4j.tree.DefaultAttribute>\n      </attributes>\n    </element>\n    <toJID>\n      <domain>sip.yuilop.tv</domain>\n    </toJID>\n    <fromJID>\n      <node>+34634538708</node>\n      <domain>yuilop.tv</domain>\n      <resource>I(1.4.0.201205152)(tg07qk5r/0Aqt8mc/YMFu4L4wto=)</resource>\n    </fromJID>\n    <jingle xmlns=\"urn:xmpp:jingle:1\" action=\"session-initiate\" sid=\"9C6BAB149CCC48799925E9E5F2B2B18B\" initiator=\"+34634538708@194.183.72.28/sip\" responder=\"0031611537782@sip.yuilop.tv\">\n      <content creator=\"initiator\" name=\"voice\">\n        <description xmlns=\"urn:xmpp:jingle:apps:rtp:1\" media=\"audio\">\n          <payload-type id=\"0\" name=\"PCMU\" clockrate=\"8000\" channels=\"1\"/>\n          <payload-type id=\"8\" name=\"PCMA\" clockrate=\"8000\" channels=\"1\"/>\n          <payload-type id=\"104\" name=\"iLBC\" clockrate=\"8000\" channels=\"1\"/>\n          <payload-type id=\"18\" name=\"G729\" clockrate=\"8000\" channels=\"1\"/>\n          <payload-type id=\"3\" name=\"GSM\" clockrate=\"8000\" channels=\"1\"/>\n        </description>\n        <transport>\n          <candidate ip=\"87.230.83.87\" port=\"6092\" type=\"host\"/>\n        </transport>\n      </content>\n    </jingle>\n  </receivedJingle>\n  <initiateIQ reference=\"../receivedJingle\"/>\n  <userContactBind class=\"java.util.concurrent.ConcurrentHashMap\" serialization=\"custom\">\n    <unserializable-parents/>\n    <java.util.concurrent.ConcurrentHashMap>\n      <default>\n        <segmentMask>15</segmentMask>\n        <segmentShift>28</segmentShift>\n        <segments>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n          <java.util.concurrent.ConcurrentHashMap_-Segment>\n            <sync class=\"java.util.concurrent.locks.ReentrantLock$NonfairSync\" serialization=\"custom\">\n              <java.util.concurrent.locks.AbstractQueuedSynchronizer>\n                <default>\n                  <state>0</state>\n                </default>\n              </java.util.concurrent.locks.AbstractQueuedSynchronizer>\n              <java.util.concurrent.locks.ReentrantLock_-Sync>\n                <default/>\n              </java.util.concurrent.locks.ReentrantLock_-Sync>\n            </sync>\n            <loadFactor>0.75</loadFactor>\n          </java.util.concurrent.ConcurrentHashMap_-Segment>\n        </segments>\n      </default>\n      <string>+34634538708@194.183.72.28</string>\n      <org.zoolu.sip.header.ContactHeader>\n        <name>Contact</name>\n        <value>&lt;sip:+34634538708@194.183.72.28:5060;transport=udp&gt;</value>\n      </org.zoolu.sip.header.ContactHeader>\n      <null/>\n      <null/>\n    </java.util.concurrent.ConcurrentHashMap>\n  </userContactBind>\n  <retries>0</retries>\n  <timestamp>1338025771341</timestamp>\n  <active>true</active>\n  <sentRequestsCounter>\n    <value>1</value>\n  </sentRequestsCounter>\n  <relayIQ>\n    <element class=\"org.dom4j.tree.DefaultElement\">\n      <qname reference=\"../../../sentJingle/element/qname\"/>\n      <parentBranch class=\"org.dom4j.tree.DefaultDocument\">\n        <rootElement class=\"org.dom4j.tree.DefaultElement\" reference=\"../..\"/>\n        <content>\n          <org.dom4j.tree.DefaultElement reference=\"../../..\"/>\n        </content>\n        <documentFactory reference=\"../../../../sentJingle/element/qname/org.dom4j.QName/default/documentFactory\"/>\n      </parentBranch>\n      <attributes class=\"list\">\n        <org.dom4j.tree.DefaultAttribute>\n          <qname reference=\"../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute/qname\"/>\n          <value>result</value>\n          <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n        </org.dom4j.tree.DefaultAttribute>\n        <org.dom4j.tree.DefaultAttribute>\n          <qname reference=\"../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute[2]/qname\"/>\n          <value>721-4</value>\n          <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n        </org.dom4j.tree.DefaultAttribute>\n        <org.dom4j.tree.DefaultAttribute>\n          <qname reference=\"../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute[4]/qname\"/>\n          <value>+34634538708@relay.yuilop.tv</value>\n          <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n        </org.dom4j.tree.DefaultAttribute>\n        <org.dom4j.tree.DefaultAttribute>\n          <qname reference=\"../../../../../sentJingle/element/attributes/org.dom4j.tree.DefaultAttribute[3]/qname\"/>\n          <value>sip.yuilop.tv</value>\n          <parent class=\"org.dom4j.tree.DefaultElement\" reference=\"../../..\"/>\n        </org.dom4j.tree.DefaultAttribute>\n      </attributes>\n    </element>\n    <toJID>\n      <domain>sip.yuilop.tv</domain>\n    </toJID>\n    <fromJID>\n      <node>+34634538708</node>\n      <domain>relay.yuilop.tv</domain>\n    </fromJID>\n    <host>87.230.83.87</host>\n    <localport>6092</localport>\n    <remoteport>6094</remoteport>\n    <channelId>x0.2591.0X</channelId>\n    <isRequest>false</isRequest>\n  </relayIQ>\n  <connected>false</connected>\n  <sessionCredit>\n    <maxDurationInSeconds>180</maxDurationInSeconds>\n    <routeType>pstn</routeType>\n    <startTime>0</startTime>\n    <finishTime>0</finishTime>\n    <charged>false</charged>\n  </sessionCredit>\n</org.jinglenodes.session.CallSession>";

        final CallSession cs2 = sessionMapper.fromXml(x);

//        assertEquals(1, sipInviteSent.get());
//        assertEquals(1, sipCancelSent.get());

    }

    public void testInvalidSipSDP() {

    }

    public void testContact() {
        final String contact = SipProcessor.getContact("test", Main.getSipGatewayApplication().getSipGatewayComponent().getGatewaySipRouter().getSipProvider());
        System.out.println("C: " + contact);
    }

    public void resetCounters() {
        sipInviteSent.set(0);
        sipAcceptSent.set(0);
        sipByeSent.set(0);
        sipCancelSent.set(0);
    }

    public static JingleIQ fakeJingleInitiate(final String initiator, final String responder, final String to, final String sid) {
        final Jingle jingle = new Jingle(sid, initiator, responder, Jingle.SESSION_INITIATE);
        jingle.setContent(new Content("initiator", "audio", "both", new Description("audio"), new RawUdpTransport(new Candidate("10.166.108.22", "10000", "0"))));
        jingle.getContent().getDescription().addPayload(Payload.G729);
        final JingleIQ jingleIQ = new JingleIQ(jingle);
        jingleIQ.setTo(to);
        jingleIQ.setFrom(initiator);
        log.debug(jingle.toString());
        return jingleIQ;
    }

}
